

#include "conf.h"

int *video_quality = &conf.video_quality;
int *video_mode    = &conf.video_mode;

//long def_table1[56]={
//0x10000,0xC000,0x5800, 0x2000, 0x1C6A, 0x1550,0x9C5,  0x38D,  0x3C45, 0x2D34, 0x14B8, 0x788,  0x5F60, 0x4788,
//0x20C9, 0xBE1, 0x8661, 0x64C9, 0x2E31, 0x10CB,0xB21A, 0x8594, 0x3D39, 0x1642, 0xE249, 0xA9B8, 0x4DC9, 0x1C48,
//0x117D2,0xD1DF,0x6030, 0x22F9, 0x153D5,0xFEE1,0x74D1, 0x2A79, 0x195F8,0x1307C,0x8B8D, 0x32AA, 0x1E01C,0x16817,
//0xA509, 0x3C01,0x2328E,0x1A5ED,0xC160, 0x4637,0x28C99,0x1E975,0xE054, 0x5190, 0x2F08B,0x2346B,0x102AF,0x5E0E
//};

//long def_table2[12]={0xE666,0xACCD,0x4F33,0x1CCD,-0x170A,-0x1148,-0x7EB,-0x2E1,-0x2BC6,-0x20D5,-0xF0C,-0x579};

//long table1[56], table2[12];

void change_video_tables(int a, int b){
// int i;
// for (i=0;i<56;i++) table1[i]=(def_table1[i]*a)/b;
// for (i=0;i<12;i++) table2[i]=(def_table2[i]*a)/b;
}

//long CompressionRateTable[]={0x60, 0x5D, 0x5A, 0x57, 0x54, 0x51, 0x4D, 0x48, 0x42, 0x3B, 0x32, 0x29, 0x22, 0x1D, 0x17, 0x14, 0x10, 0xE, 0xB, 9, 7, 6, 5, 4, 3, 2, 1};

void __attribute__((naked,noinline)) set_quality(int *x){ // 0 highest; +14 lowest
 asm volatile("STMFD   SP!, {R0-R12,LR}\n");
 if (conf.video_mode) *x=14*(98-(conf.video_quality-1))/98;
 asm volatile("LDMFD   SP!, {R0-R12,PC}\n");
}

void __attribute__((naked,noinline)) movie_record_task(){
 asm volatile(
"                STMFD   SP!, {R4,LR}\n"
"                SUB     SP, SP, #4\n"
"                MOV     R4, SP\n"
"                B       loc_FF9362DC\n"
"loc_FF936244:\n"
"                LDR     R3, =0x67070\n"
"                LDR     R2, [R3]\n"
"                CMP     R2, #0\n"
"                BNE     loc_FF9362C8\n"
"                LDR     R3, [R0]\n"
"                SUB     R3, R3, #1\n"
"                CMP     R3, #7\n"
"                LDRLS   PC, [PC,R3,LSL#2]\n"
"                B       loc_FF9362C8\n"
"                .long loc_FF936288\n"
"                .long loc_FF936290\n"
"                .long loc_FF9362A8\n"
"                .long loc_FF936298\n"
"                .long loc_FF9362B0\n"
"                .long loc_FF9362A0\n"
"                .long loc_FF9362C0\n"
"                .long loc_FF9362B8\n"
"loc_FF936288:\n"
"                BL      sub_FF936358\n"
"                B       loc_FF9362C4\n"
"loc_FF936290:\n"
// there's no unsetzoomformovie function in the firmware...
//"                BL      unlock_optical_zoom\n" //just experimenting...
"                BL      sub_FF936570_my\n" // -> to movie time limit override
"                B       loc_FF9362C4\n"
"loc_FF936298:\n"
"                BL      sub_FF936920_my\n" // ->
"                B       loc_FF9362C4\n"
"loc_FF9362A0:\n"
"                BL      sub_FF936CCC\n"
"                B       loc_FF9362C4\n"
"loc_FF9362A8:\n"
"                BL      sub_FF936B74\n"
"                B       loc_FF9362C4\n"
"loc_FF9362B0:\n"
"                BL      sub_FF936D84\n"
"                B       loc_FF9362C4\n"
"loc_FF9362B8:\n"
"                BL      sub_FF936E20\n"
"                B       loc_FF9362C4\n"
"loc_FF9362C0:\n"
"                BL      sub_FF936BC4\n"
"loc_FF9362C4:\n"
"                LDR     R1, [SP]\n"
"loc_FF9362C8:\n"
"                LDR     R3, =0x66FF4\n"
"                MOV     R2, #0\n"
"                STR     R2, [R1]\n"
"                LDR     R0, [R3]\n"
"                BL      sub_FF822738\n" //PostMessageQueue?
"loc_FF9362DC:\n"
"                LDR     R3, =0x66FF0\n"
"                MOV     R1, R4\n"
"                LDR     R0, [R3]\n"
"                MOV     R2, #0\n"
"                BL      sub_FF822320\n"
"                LDR     R0, [SP]\n"
"                CMP     R0, #0\n"
"                MOV     R1, R0\n"
"                BNE     loc_FF936244\n"
"                LDR     R3, =0x66FEC\n"
"                LDR     R0, [R3]\n"
"                BL      sub_FF823144\n" //GiveSemaphore [0x66fec]
"                BL      sub_FF823B44\n" //ExitTask
"                ADD     SP, SP, #4\n"
"                LDMFD   SP!, {R4,PC}\n"
 );
}

void __attribute__((naked,noinline)) sub_FF936920_my(){
 asm volatile(
"                STMFD   SP!, {R4-R7,LR}\n"
"                LDR     R4, =0x67088\n"
"                SUB     SP, SP, #0x10\n"
"                LDR     R3, [R4]\n"
"                CMP     R3, #3\n"
"                MOV     R5, R0\n"
"                MOVEQ   R3, #4\n"
"                STREQ   R3, [R4]\n"
"                LDR     R3, =0x67108\n"
"                MOV     LR, PC\n"
"                LDR     PC, [R3]\n"
"                LDR     R2, [R4]\n"
"                CMP     R2, #4\n"
"                BNE     loc_FF936A84\n"
"                ADD     R0, SP, #0x24-0x18\n"
"                BL      sub_FF9382AC_my\n" // ->
"                CMP     R0, #0\n"
"                BNE     loc_FF936990\n"
"                LDR     R3, =0x67078\n"
"                LDR     R2, [R3]\n"
"                CMP     R2, #1\n"
"                BNE     loc_FF9369AC\n"
"                LDR     R2, =0x670B0\n"
"                LDR     R1, =0x6708C\n"
"                LDR     R12, [R2]\n"
"                LDR     R3, [R1]\n"
"                CMP     R12, R3\n"
"                BCC     loc_FF9369AC\n"
"loc_FF936990:\n"
"                BL      sub_FF936AC4_my\n" // -> check sub_FF9382AC_my's return status & others (size limit for example)
"                LDR     R3, =0x67104\n"
"                LDR     R0, [R3]\n"
"                BL      sub_FFA44760\n"
"                MOV     R3, #5\n"
"                STR     R3, [R4]\n"
"                B       loc_FF936A84\n"
"loc_FF9369AC:\n"
"                LDR     R6, =0x670B8\n"
"                LDR     R7, =0x6707C\n"
"                LDR     R0, [R5,#4]\n"
"                LDR     R1, [SP,#0x24-0x18]\n"
"                ADD     R12, SP, #0x24-0x20\n"
"                ADD     R3, SP, #0x24-0x1C\n"
"                LDR     R2, [R6]\n"
"                MOV     R4, #1\n"
"                STR     R12, [SP,#0x24-0x24]\n"
"                STR     R4, [R7]\n"
"                BL      sub_FF8A03D8\n" //recording dies quickly when commented out
"                LDR     R3, =0x66FEC\n"
"                MOV     R1, #0x3E8\n" //1000 decimal -> timeout value
"                LDR     R0, [R3]\n" //semaphore (id,...)
"                BL      sub_FF822F5C\n" //TakeSemaphore [0x66fec], 1000
"                CMP     R0, #9\n"
"                BNE     loc_FF936A00\n" //not a timeout?
"                BL      sub_FF9388E8\n"
"                LDR     R3, =0x67088\n"
"                LDR     R0, =0xFF936908\n" //Jpegtimeout
"                B       loc_FF936A18\n"
"loc_FF936A00:\n"
"                LDR     R5, [SP,#0x24-0x20]\n"
"                CMP     R5, #0\n"
"                BEQ     loc_FF936A24\n"
"                BL      sub_FF9388E8\n"
"                LDR     R3, =0x67088\n"
"                LDR     R0, =0xFF936914\n" //Jpegicerror
"loc_FF936A18:\n"
"                STR     R4, [R3]\n"
"                BL      sub_FF94F7E8\n"
"                B       loc_FF936A84\n"
"loc_FF936A24:\n"
"                BL      sub_FF8A0434\n"
"                LDR     R0, [SP,#0x24-0x18]\n"
"                LDR     R1, [SP,#0x24-0x1C]\n"
"                BL      sub_FF938670\n"
"                LDR     R4, =0x670B0\n"
"                LDR     R3, [R4]\n"
"                ADD     R3, R3, #1\n"
"                LDR     R0, [SP,#0x24-0x1C]\n"
"                MOV     R1, R6\n"
"                STR     R3, [R4]\n"
"                MOV     R2, R5\n"
"                BL      sub_FF93727C_my\n" // ->
"                LDR     R3, =0x67098\n"
"                LDR     R4, [R4]\n"
"                LDR     R1, [R3]\n"
"                MOV     R0, R4\n"
"                BL      sub_FFAB8184\n"
"                CMP     R0, #0\n"
"                BNE     loc_FF936A80\n"
"                MOV     R0, R4\n"
"                LDR     R3, =0x670E0\n"
"                MOV     LR, PC\n"
"                LDR     PC, [R3]\n"
"loc_FF936A80:\n"
"                STR     R5, [R7]\n"
"loc_FF936A84:\n"
"                ADD     SP, SP, #0x10\n"
"                LDMFD   SP!, {R4-R7,PC}\n"
 );
}

void __attribute__((naked,noinline)) sub_FF9382AC_my(){
 asm volatile(
"                STMFD   SP!, {R4-R11,LR}\n"
"                LDR     R12, =0x673B4\n"
"                LDR     R3, =0x673CC\n"
"                SUB     SP, SP, #4\n"
"                LDR     R2, [R12]\n"
"                LDR     R1, [R3]\n"
"                ADD     R7, R2, #1\n"
"                LDR     R3, =0x67444\n"
"                CMP     R7, R1\n"
"                STR     R7, [R12]\n"
"                MOV     R9, R0\n"
"                LDR     R11, [R3]\n"
"                MOVHI   R3, #0\n"
"                STRHI   R3, [R9]\n"
"                MOVHI   R0, #0x80000001\n"
"                BHI     loc_FF9385E4\n"
"                LDR     R3, =0x67428\n"
"                LDR     R4, [R3]\n"
"                MOV     R0, R7\n"
"                MOV     R1, R4\n"
"                BL      sub_FFAB8184\n"
"                CMP     R0, #1\n"
"                BNE     loc_FF9384A8\n"
"                LDR     R1, =0x67454\n"
"                LDR     R3, =0x67448\n"
"                LDR     R2, [R1]\n"
"                LDR     R1, =0x673A0\n"
"                LDR     R8, [R3]\n"
"                LDR     R5, [R1]\n"
"                ADD     R2, R8, R2\n"
"                CMP     R2, R5\n"
"                BNE     loc_FF93834C\n"
"                MOV     R1, R4\n"
"                MOV     R0, R7\n"
"                BL      sub_FFAB7AF4\n"
"                LDR     R4, =0x673A8\n"
"                ADD     R0, R0, #1\n"
"                AND     R0, R0, #1\n"
"                STR     R8, [R4,R0,LSL#2]\n"
"                B       loc_FF938368\n"
"loc_FF93834C:\n"
"                MOV     R1, R4\n"
"                MOV     R0, R7\n"
"                BL      sub_FFAB7AF4\n"
"                LDR     R4, =0x673A8\n"
"                ADD     R0, R0, #1\n"
"                AND     R0, R0, #1\n"
"                STR     R5, [R4,R0,LSL#2]\n"
"loc_FF938368:\n"
"                LDR     R3, =0x673B4\n"
"                LDR     R2, =0x67428\n"
"                LDR     R0, [R3]\n"
"                LDR     R1, [R2]\n"
"                BL      sub_FFAB7AF4\n"
"                LDR     R3, =0x673E8\n"
"                ADD     R0, R0, #1\n"
"                AND     R0, R0, #1\n"
"                LDR     R1, =0x67448\n"
"                LDR     R12, =0x67454\n"
"                LDR     LR, [R4,R0,LSL#2]\n"
"                LDR     R2, [R3]\n"
"                LDR     R0, [R1]\n"
"                LDR     R3, [R12]\n"
"                ADD     R1, LR, R2\n"
"                ADD     R2, R1, #8\n"
"                ADD     LR, R0, R3\n"
"                CMP     R2, LR\n"
"                BLS     loc_FF9383CC\n"
"                ADD     R3, R0, R1\n"
"                RSB     R3, LR, R3\n"
"                LDR     R2, =0x673A0\n"
"                ADD     R3, R3, #8\n"
"                STR     R3, [R2]\n"
"                B       loc_FF9383D4\n"
"loc_FF9383CC:\n"
"                LDR     R3, =0x673A0\n"
"                STR     R2, [R3]\n"
"loc_FF9383D4:\n"
"                LDR     R3, =0x673E8\n"
"                LDR     R0, =0x67400\n"
"                LDR     R2, [R3]\n"
"                LDR     R3, [R0,#4]\n"
"                ADD     R2, R2, #0x18\n"
"                MOV     R1, R2\n"
"                MOV     R2, #0\n"
"                CMP     R2, R3\n"
"                BHI     loc_FF938564\n"
"                BNE     loc_FF938408\n"
"                LDR     R3, [R0]\n"
"                CMP     R1, R3\n"
"                BHI     loc_FF938564\n"
"loc_FF938408:\n"
"                LDR     R3, =0x673E8\n"
"                LDR     R10, =0x67400\n"
"                LDR     R3, [R3]\n"
"                LDMIA   R10, {R1,R2}\n"
"                STR     R3, [SP]\n"
"                LDR     R0, =0x673B4\n"
"                LDR     R12, =0x67428\n"
"                SUBS    R5, R1, R3\n"
"                SBC     R6, R2, #0\n"
"                LDR     R8, [R12]\n"
"                MVN     R4, #0\n"
"                MVN     R3, #0x17\n"
"                LDR     R7, [R0]\n"
"                ADDS    R5, R5, R3\n"
"                ADC     R6, R6, R4\n"
"                SUB     R0, R7, #1\n"
"                MOV     R1, R8\n"
"                STMIA   R10, {R5,R6}\n"
"                BL      sub_FFAB7AF4\n"
"                CMP     R7, #1\n"
"                MLA     R0, R8, R0, R0\n"
"                BEQ     loc_FF9384A8\n"
"                SUB     R3, R0, #1\n"
"                MOV     R3, R3,LSL#4\n"
"                ADD     R4, R11, #0x10\n"
"                ADD     R5, R11, #0x14\n"
"                LDR     R1, [R5,R3]\n"
"                LDR     R2, [R4,R3]\n"
"                LDR     LR, =0x62773130\n"
"                ADD     R2, R2, R1\n"
"                MOV     R3, R0,LSL#4\n"
"                ADD     R2, R2, #8\n"
"                ADD     R12, R11, #0xC\n"
"                ADD     R1, R11, #8\n"
"                MOV     R0, #0\n"
"                STR     LR, [R1,R3]\n"
"                STR     R0, [R12,R3]\n"
"                STR     R2, [R4,R3]\n"
"                LDR     R2, [SP]\n"
"                STR     R2, [R5,R3]\n"
"loc_FF9384A8:\n"
"                LDR     R1, =0x673A0\n"
"                LDR     R3, =0x6739C\n"
"                LDR     R2, [R1]\n"
"                LDR     R1, [R3]\n"
"                ADD     R2, R2, #8\n"
"                CMP     R2, R1\n"
"                STR     R2, [R9]\n"
"                BHI     loc_FF9384E0\n"
"                LDR     LR, =0x673F8\n"
"                LDR     R3, [LR]\n"
"                ADD     R3, R2, R3\n"
"                CMP     R1, R3\n"
"                BHI     loc_FF9384E4\n"
"                B       loc_FF938524\n"
"loc_FF9384E0:\n"
"                LDR     LR, =0x673F8\n"
"loc_FF9384E4:\n"
"                LDR     R3, =0x67448\n"
"                LDR     R2, =0x67454\n"
"                LDR     R12, [R3]\n"
"                LDR     R0, [R2]\n"
"                LDR     R1, [R9]\n"
"                LDR     R3, [LR]\n"
"                ADD     R2, R1, R3\n"
"                ADD     R1, R12, R0\n"
"                CMP     R2, R1\n"
"                BLS     loc_FF938534\n"
"                LDR     R3, =0x6739C\n"
"                RSB     R2, R1, R2\n"
"                LDR     R1, [R3]\n"
"                ADD     R2, R12, R2\n"
"                CMP     R1, R2\n"
"                BHI     loc_FF938534\n"
"loc_FF938524:\n"
"                MOV     R3, #0\n"
"                STR     R3, [R9]\n"
"                MOV     R0, #0x80000003\n"
"                B       loc_FF9385E4\n"
"loc_FF938534:\n"
"                LDR     R3, [LR]\n"
"                LDR     R12, =0x67400\n"
"                ADD     R3, R3, #0x18\n"
"                LDR     R2, [R12,#4]\n"
"                MOV     R0, R3\n"
"                MOV     R1, #0\n"
"                CMP     R1, R2\n"
"                BHI     loc_FF938564\n"
"                BNE     loc_FF938574\n"
"                LDR     R3, [R12]\n"
"                CMP     R0, R3\n"
"                BLS     loc_FF938574\n"
"loc_FF938564:\n"
"                MOV     R3, #0\n"
"                STR     R3, [R9]\n"
"                MOV     R0, #0x80000005\n"
"                B       loc_FF9385E4\n"
"loc_FF938574:\n"
"                LDR     R1, =0x673E0\n"
"                LDR     R0, =0x67428\n"
"                LDR     R3, [R1]\n"
"                LDR     R2, [R0]\n"
"                ADD     R3, R3, R2,LSL#4\n"
"                ADD     R3, R3, R3,LSL#2\n"
"                LDR     R12, =0x67400\n"
"                MOV     R3, R3,LSL#1\n"
"                ADD     R3, R3, #0xA0\n"
"                LDR     R2, [R12,#4]\n"
"                MOV     R0, R3\n"
"                MOV     R1, #0\n"
"                CMP     R1, R2\n"
"                BHI     loc_FF9385BC\n"
"                BNE     loc_FF9385E0\n"
"                LDR     R3, [R12]\n"
"                CMP     R0, R3\n"
"                BLS     loc_FF9385E0\n"
"loc_FF9385BC:\n"
"                LDR     R4, =0x67410\n"
"                LDR     R1, [R4]\n"
"                CMP     R1, #0\n"
"                BNE     loc_FF9385E0\n"
"                MOV     R0, #0x3140\n"
"                ADD     R0, R0, #8\n"
"                BL      sub_FF953894\n"
"                MOV     R3, #1\n"
"                STR     R3, [R4]\n"
"loc_FF9385E0:\n"
"                MOV     R0, #0\n"
"loc_FF9385E4:\n"
"                ADD     SP, SP, #4\n"
"                LDMFD   SP!, {R4-R11,PC}\n"
 );
}


void __attribute__((naked,noinline)) sub_FF93727C_my(){ //this function doesn't return a value and is only referenced once
/*
[0x67120]: seems to specify which table (compression quality?) to use, 0(best)..14
*/
 asm volatile(
"                STMFD   SP!, {R4-R7,LR}\n"
"                LDR     R12, =0x67118\n"
"                LDR     LR, [R12]\n" //[0x67118] -> lr
"                CMP     LR, #0\n" 
"                MOV     R5, R0\n" //param 0 -> r5 (caller passes a local variable here)
"                MOV     R6, R1\n" //param 1 -> r6 (caller sets this to 0x670b8)
"                BEQ     loc_FF9372AC\n" //if([0x67118]=0) then jump
"                LDR     R1, =0x67124\n"
"                LDR     R3, [R1]\n"
"                CMP     R3, #1\n"
"                BNE     loc_FF9372C4\n" //if([0x67124]!=1) then jump
"                B       loc_FF9372B0\n"
"loc_FF9372AC:\n"
"                LDR     R1, =0x67124\n"
"loc_FF9372B0:\n"
"                MOV     R3, #0\n"
"                STR     R3, [R1]\n" //0 -> [0x67124]
"                LDR     R7, =0x67120\n"
"                STR     R5, [R12]\n" //param 0 -> [0x67118]
"                B       loc_FF9373A8\n"
"loc_FF9372C4:\n"
"                CMP     R2, #1\n"       //param 2, is it 1? (no, it can never be 1, it's always 0, see caller)
"                LDREQ   R7, =0x67120\n" //param 2 is 1
"                MOVEQ   R3, #0xA\n"     //param 2 is 1
"                STREQ   R3, [R7]\n"     //param 2 is 1, 0xa -> [0x67120]
"                BEQ     loc_FF9373A8\n" //param 2 is 1, go to end
"                LDR     R3, =0x6711C\n"
"                LDR     R2, [R3]\n" //[0x6711c] -> r2
"                LDR     R12, =0x5744\n"
"                MOV     R2, R2,LSL#2\n" //r2=r2*4 (for addressing)
"                LDR     R1, =0x5824\n"
"                LDR     R3, [R12,R2]\n" //[0x5744+r2] -> r3
"                LDR     R0, [R1,R2]\n" //[0x5824+r2] -> r0
"                SUBS    R4, LR, R3\n" //r4=lr-r3 (signed)
"                RSB     R1, R0, LR\n" //r1=lr-r0
"                BMI     loc_FF937348\n" //if(r4<0) then jump
"                MOV     R0, #1\n"
"                LDR     R7, =0x67120\n"
"loc_FF937308:\n"
"                CMP     R0, #3\n"
"                LDR     LR, =0x6711C\n"
"                LDR     R1, =0x5744\n"
"                LDR     R12, =0x67120\n"
"                BGT     loc_FF937394\n" //if(r0>3) then jump
"                LDR     R3, [R12]\n" //[0x67120] -> r3
"                CMP     R3, #0xD\n"
"                ADD     R2, R3, #1\n"
"                STRLS   R2, [R12]\n" //if (r3<=0xd) then r3+1 -> [0x67120]
"                LDR     R3, [LR]\n" //[0x6711c] -> r3
"                ADD     R3, R3, R0,LSL#2\n" //r3=r3+r0*4
"                LDR     R2, [R1,R3,LSL#2]\n" //[0x5744+r3*4] -> r2
"                CMP     R4, R2\n"
"                ADD     R0, R0, #1\n" //r0=r0+1
"                BGE     loc_FF937308\n" //if(r4>=r2) then loop back
"                B       loc_FF937394\n"
"loc_FF937348:\n"
"                CMP     R1, #0\n"
"                BGT     loc_FF9373A4\n" //if(r1>0) then jump
"                MOV     R0, #1\n"
"                LDR     R7, =0x67120\n"
"loc_FF937358:\n"
"                CMP     R0, #3\n"
"                LDR     LR, =0x6711C\n"
"                LDR     R4, =0x5824\n"
"                LDR     R12, =0x67120\n"
"                BGT     loc_FF937394\n" //if(r0>3) then jump
"                LDR     R3, [R12]\n" //[0x67120] -> r3
"                CMP     R3, #0\n"
"                SUB     R2, R3, #1\n"
"                STRNE   R2, [R12]\n" //if (r3!=0) then r3-1 -> [0x67120]
"                LDR     R3, [LR]\n" //[0x6711c] -> r3
"                ADD     R3, R3, R0,LSL#2\n" //r3=r3+r0*4
"                LDR     R2, [R4,R3,LSL#2]\n" //[0x5824+r3*4] -> r2
"                CMP     R1, R2\n"
"                ADD     R0, R0, #1\n" //r0=r0+1
"                BLE     loc_FF937358\n" //if(r1<=r2) then loop back
"loc_FF937394:\n"
"                LDR     R2, =0x67124\n"
"                MOV     R3, #1\n"
"                STR     R3, [R2]\n" //1 -> [0x67124]
"                B       loc_FF9373A8\n"
"loc_FF9373A4:\n"
"                LDR     R7, =0x67120\n"
"loc_FF9373A8:\n"
"                LDR     R3, =0x67118\n"
"                mov     r0, r7\n" //+
"                bl      set_quality\n" //+
"                MOV     R0, R6\n" //param 1 -> r0
"                LDR     R1, [R7]\n" //[0x67120] -> r1
"                STR     R5, [R3]\n" //param 0 -> [0x67118]
"                LDMFD   SP!, {R4-R7,LR}\n"
"                B       loc_FF89AC9C\n"
"loc_FF89AC9C:\n"
"                LDR     R3, =0xFF89A498\n" // a table (of quality parameters?) starts here
"                ADD     R3, R3, R1,LSL#7\n" //r3=r3+r1*128
"                STR     R3, [R0]\n" //r3 -> [param 1]
"                MOV     PC, LR\n"
 );
}

void __attribute__((naked,noinline)) sub_FF936AC4_my(){
 asm volatile(
"                CMP     R0, #0x80000001\n"
"                BEQ     loc_FF936AFC\n"
"                BHI     loc_FF936ADC\n"
"                CMP     R0, #0\n"
"                BEQ     loc_FF936AF0\n"
"                B       loc_FF936B5C\n"
"loc_FF936ADC:\n"
"                CMP     R0, #0x80000003\n"
"                BEQ     loc_FF936B0C\n"
"                CMP     R0, #0x80000005\n"
"                BEQ     loc_FF936B1C\n"
"                B       loc_FF936B5C\n"
"loc_FF936AF0:\n"
"                LDR     R3, =0x670B4\n"
"                STR     R0, [R3]\n"
"                MOV     PC, LR\n"
"loc_FF936AFC:\n"
"                LDR     R2, =0x670B4\n"
"                MOV     R3, #4\n"
"                STR     R3, [R2]\n"
"                MOV     PC, LR\n"
"loc_FF936B0C:\n"
"                LDR     R2, =0x670B4\n"
"                MOV     R3, #1\n"
"                STR     R3, [R2]\n"
"                MOV     PC, LR\n"
"loc_FF936B1C:\n"
"                LDR     R2, =0x670D8\n"
"                LDR     R3, [R2,#4]\n"
"                CMP     R3, #0\n"
"                BHI     loc_FF936B3C\n"
"                BNE     loc_FF936B4C\n"
"                LDR     R3, [R2]\n"
"                CMP     R3, #0x40000000\n" //must be the 1G size limit check
"                B       loc_FF936B4C\n" // changed BLS to B
"loc_FF936B3C:\n"
"                LDR     R2, =0x670B4\n"
"                MOV     R3, #3\n"
"                STR     R3, [R2]\n"
"                MOV     PC, LR\n"
"loc_FF936B4C:\n"
"                LDR     R2, =0x670B4\n"
"                MOV     R3, #2\n"
"                STR     R3, [R2]\n"
"                MOV     PC, LR\n"
"loc_FF936B5C:\n"
"                LDR     R2, =0x670B4\n"
"                MOV     R3, #0\n"
"                STR     R3, [R2]\n"
"                MOV     PC, LR\n"
 );
}

//

void __attribute__((naked,noinline)) sub_FF936570_my(){
 asm volatile(
"                STMFD   SP!, {R4-R11,LR}\n"
"                LDR     R3, =0x67098\n"
"                SUB     SP, SP, #0x38\n"
"                LDR     R4, [R3]\n"
"                LDR     R5, =0x670D8\n"
"                LDR     R3, =0x6708C\n"
"                LDR     R12, =0x67078\n"
"                STR     R4, [R3]\n"
"                MOV     R11, #0\n"
"                LDMIA   R5, {R3,R4}\n"
"                LDR     LR, =0x6707C\n"
"                STR     R11, [R12]\n"
"                ADD     R12, SP, #0x5C-0x2C\n"
"                STR     R11, [LR]\n"
"                MOV     R0, #6\n"
"                STMDB   R12, {R3,R4}\n"
"                MOV     R1, R11\n"
"                LDR     R2, =0x67110\n"
"                BL      sub_FF813A1C\n"
"                LDR     R3, [R5,#4]\n"
"                CMP     R3, R11\n"
"                BHI     loc_FF9365E8\n"
"                BNE     loc_FF9365D8\n"
"                LDR     R3, [R5]\n"
"                CMP     R3, #0x40000000\n"
"                BHI     loc_FF9365E8\n"
"loc_FF9365D8:\n"
"                LDR     R2, =0x670BC\n"
"                LDR     R3, [R2]\n"
"                CMP     R3, #0\n"
"                BNE     loc_FF9365F8\n"
"loc_FF9365E8:\n"
"                MOV     R4, #0\n"
"                MOV     R3, #0x40000000\n"
"                ADD     R12, SP, #0x5C-0x2C\n"
"                STMDB   R12, {R3,R4}\n"
"loc_FF9365F8:\n"
"                LDR     R3, =0x67098\n"
"                LDR     R2, =0x88888889\n"
"                LDR     R7, [R3]\n"
"                UMULL   R3, R12, R2, R7\n"
"                MOV     R12, R12,LSR#2\n"
"                LDR     R8, =0x67080\n"
"                BIC     R12, R12, #1\n"
"                LDR     LR, =0x67110\n"
"                LDR     R10, =0x67090\n"
"                LDR     R2, =0x67094\n"
"                MOV     R12, R12,LSL#16\n"
"                LDR     R6, [R8]\n"
"                MOV     R12, R12,LSR#16\n"
"                MOV     R9, #0x2B00\n" // audio sample rate, first part
"                LDR     R5, =0xFF936B98\n"
"                LDR     R1, [LR,#4]\n"
"                LDR     R3, [R2]\n"
"                LDR     R0, [LR]\n"
"                MOV     R4, #1\n" // audio channels?
"                ADD     LR, SP, #0x5C-0x28\n"
"                STR     R12, [SP,#0x5C-0x40]\n"
"                LDR     R2, [R10]\n" //picture width
"                MOV     R12, #8\n" // audio bit depth (setting it to 16 results in broken audio: 8bit samples - nothing - 8bit samples - etc, also breaks the avi)
"                ADD     R9, R9, #0x10\n" // 0x2b00+0x10 (11024dec, canon's usual audio sample rate) -> 22050 causes crash
"                STR     R6, [SP,#0x5C-0x58]\n"
"                STR     R12, [SP,#0x5C-0x48]\n"
"                STR     R5, [SP,#0x5C-0x3C]\n"
"                STR     LR, [SP,#0x5C-0x38]\n"
"                STR     R7, [SP,#0x5C-0x5C]\n"
"                STR     R9, [SP,#0x5C-0x54]\n"
"                STR     R9, [SP,#0x5C-0x50]\n"
"                STR     R4, [SP,#0x5C-0x4C]\n"
"                STR     R4, [SP,#0x5C-0x44]\n"
"                BL      sub_FF9375B8_my\n" // ->
"                ADD     R3, SP, #0x5C-0x2C\n"
"                LDR     R12, =0x670C0\n"
"                LDMDB   R3, {R1,R2}\n"
"                LDR     R3, =0x670BC\n"
"                LDR     R0, [R3]\n"
"                LDR     R3, [R12]\n"
"                BL      sub_FF937834\n"
"                LDR     R3, [R8]\n"
"                LDR     R1, =0x670B8\n"
"                MOV     R2, #0\n"
"                LDR     R0, [R10]\n"
"                BL      sub_FF9371C8\n"
"                BL      sub_FF936890\n"
"                MOV     R2, R4\n"
"                MOV     R1, R0\n"
"                LDR     R0, [SP,#0x5C-0x28]\n"
"                BL      sub_FF8A0398\n"
"                LDR     R0, =0xFF9368F0\n"
"                MOV     R1, #0\n"
"                BL      sub_FF8A0440\n"
"                LDR     R0, =0xFF93651C\n" //SoundDeviceIn
"                MOV     R1, #0\n"
"                BL      sub_FFA44698\n"
"                LDR     R6, =0x67104\n"
"                TST     R0, #1\n"
"                STR     R0, [R6]\n"
"                BEQ     loc_FF936700\n"
"                MOV     R2, #0x1EC\n"
"                LDR     R0, =0xFF93652C\n" //!IS_ERROR( hSoundHandle )
"                LDR     R1, =0xFF936548\n" //MovieRecorder.c
"                ADD     R2, R2, #2\n"
"                BL      sub_FF814C10\n"
"loc_FF936700:\n"
"                MOV     R4, #0\n"
"                LDR     R0, [R6]\n"
"                MOV     R3, #8\n"
"                MOV     R1, R4\n"
"                MOV     R2, R9\n"
"                STR     R11, [SP,#0x5C-0x5C]\n"
"                STR     R4, [SP,#0x5C-0x58]\n"
"                BL      sub_FFA448E8\n"
"                TST     R0, #1\n"
"                BEQ     loc_FF93673C\n"
"                MOV     R2, #0x1F0\n"
"                LDR     R0, =0xFF936558\n" //!IS_ERROR( RetCode )
"                LDR     R1, =0xFF936548\n" //MovieRecorder.c
"                ADD     R2, R2, #1\n"
"                BL      sub_FF814C10\n"
"loc_FF93673C:\n"
"                LDR     R0, [R6]\n"
"                LDR     R1, =0xFF936CB4\n"
"                MOV     R2, R4\n"
"                BL      sub_FFA447E4\n"
"                TST     R0, #1\n"
"                BEQ     loc_FF936768\n"
"                MOV     R2, #0x1F0\n"
"                LDR     R0, =0xFF936558\n" //!IS_ERROR( RetCode )
"                LDR     R1, =0xFF936548\n" //MovieRecorder.c
"                ADD     R2, R2, #3\n"
"                BL      sub_FF814C10\n"
"loc_FF936768:\n"
"                LDR     R3, =0x66FEC\n"
"                MOV     R1, R4\n"
"                LDR     R0, [R3]\n"
"                BL      sub_FF822F5C\n" //TakeSemaphore [0x66fec], NO_WAIT
"                ADD     R5, SP, #0x5C-0x2C\n"
"                MOV     R0, R5\n"
"                BL      sub_FF9380D4\n"
"                LDR     R7, =0xFF936D54\n"
"                LDR     R0, [R6]\n"
"                LDR     R1, [SP,#0x5C-0x2C]\n"
"                MOV     R2, R9\n"
"                MOV     R3, R7\n"
"                STR     R4, [SP,#0x5C-0x5C]\n"
"                BL      sub_FFA44798\n"
"                TST     R0, #1\n"
"                BEQ     loc_FF9367BC\n"
"                MOV     R2, #0x1F8\n"
"                LDR     R0, =0xFF936558\n" //!IS_ERROR( RetCode )
"                LDR     R1, =0xFF936548\n" //MovieRecorder.c
"                ADD     R2, R2, #1\n"
"                BL      sub_FF814C10\n"
"loc_FF9367BC:\n"
"                MOV     R0, R5\n"
"                BL      sub_FF9380D4\n"
"                LDR     R0, [R6]\n"
"                LDR     R1, [SP,#0x5C-0x2C]\n"
"                MOV     R2, R9\n"
"                MOV     R3, R7\n"
"                STR     R4, [SP,#0x5C-0x5C]\n"
"                BL      sub_FFA44798\n"
"                TST     R0, #1\n"
"                BEQ     loc_FF9367F8\n"
"                MOV     R2, #0x1FC\n"
"                LDR     R0, =0xFF936558\n" //!IS_ERROR( RetCode )
"                LDR     R1, =0xFF936548\n" //MovieRecorder.c
"                ADD     R2, R2, #2\n"
"                BL      sub_FF814C10\n"
"loc_FF9367F8:\n"
"                LDR     R0, =0x670B0\n"
"                LDR     R12, =0x67108\n"
"                LDR     R2, =0xFF936C60\n"
"                LDR     R1, =0x67088\n"
"                MOV     R3, #2\n"
"                STR     R4, [R0]\n"
"                STR     R2, [R12]\n"
"                STR     R3, [R1]\n"
"                ADD     SP, SP, #0x38\n"
"                LDMFD   SP!, {R4-R11,PC}\n"
 );
}


void __attribute__((naked,noinline)) sub_FF9375B8_my(){
 asm volatile(
"                STMFD   SP!, {R4-R11,LR}\n"
"                MOV     R10, R2\n"
"                LDR     R2, =0x67424\n"
"                SUB     SP, SP, #4\n"
"                LDRSH   R7, [SP,#0x28+0x18]\n" //1
"                LDRSH   R6, [SP,#0x28+0x1C]\n"
"                LDR     R11, [SP,#0x28+0x0]\n"
"                LDRSH   R9, [SP,#0x28+0x10]\n" //1
"                LDRSH   R8, [SP,#0x28+0x14]\n" //audio bit depth
"                STR     R3, [R2]\n"
"                LDR     R2, [SP,#0x28+0x4]\n"
"                LDR     R3, =0x6742C\n"
"                STR     R2, [R3]\n"
"                LDR     R3, [SP,#0x28+0x8]\n" //audio sr
"                LDR     R12, =0x67430\n"
"                STR     R3, [R12]\n" //audio sr -> [0x67430]
"                LDR     R2, [SP,#0x28+0xC]\n" //audio sr
"                LDR     LR, =0x67434\n"
"                LDR     R3, =0x6743C\n"
"                STR     R2, [LR]\n" //audio sr -> [0x67434]
"                LDR     R4, =0x67438\n"
"                LDR     R2, =0x6743E\n"
"                LDR     R5, =0x6743A\n"
"                STRH    R9, [R4]\n"
"                STRH    R8, [R5]\n"
"                STRH    R7, [R3]\n"
"                STRH    R6, [R2]\n"
"                LDR     R2, [SP,#0x28+0x20]\n" //0xff936b98
"                LDR     R3, =0x67460\n"
"                STR     R2, [R3]\n"
"                LDR     R3, =0x67420\n"
"                LDR     R2, =0x67428\n"
"                CMP     R10, #0x280\n" //640x480?
"                STR     R10, [R3]\n"
"                MOV     R7, R0\n"
"                STR     R11, [R2]\n"
"                MOV     R6, R1\n"
"                BNE     loc_FF93767C\n"
"                RSB     R2, R11, R11,LSL#4\n"
"                MOV     R3, #0xE100\n"
"                RSB     R2, R2, R2,LSL#4\n"
"                ADD     R3, R3, #8\n"
"                LDR     R5, =0x673F8\n"
"                LDR     R12, =0x673CC\n"
"                MOV     R1, #0x40000\n"
"                MOV     R0, R2,LSL#4\n"
"                ADD     R4, R3, R2,LSL#8\n"
"                MOV     R3, #2\n"
"                B       loc_FF9376F8\n"
"loc_FF93767C:\n" //320x240
"                CMP     R10, #0x140\n"
"                BNE     loc_FF9376D0\n"
"                RSB     R12, R11, R11,LSL#4\n"
"                LDR     R5, =0x673F8\n"
"                RSB     R0, R12, R12,LSL#4\n"
"                MOV     R2, #0x20000\n"
"                LDR     LR, =0x673CC\n"
"                MOV     R3, #0xE100\n"
"                STR     R2, [R5]\n"
"                MOV     R1, R0,LSL#4\n"
"                ADD     R3, R3, #8\n"
"                MOV     R2, #1\n"
"                CMP     R11, #0x3C\n" //60fps?
"                STR     R1, [LR]\n"
"                ADD     R4, R3, R0,LSL#8\n"
"                STR     R2, [SP,#0x28-0x28]\n"
"                MOVEQ   R3, R12,LSL#2\n"
"                MOVEQ   R4, #0xE400\n"
"                STREQ   R3, [LR]\n"
"                ADDEQ   R4, R4, #0xC8\n"
"                B       loc_FF937704\n"
"loc_FF9376D0:\n" //160x120
"                ADD     R2, R11, R11,LSL#1\n"
"                MOV     R3, #0xB40\n"
"                RSB     R2, R2, R2,LSL#4\n"
"                ADD     R3, R3, #8\n"
"                LDR     R5, =0x673F8\n"
"                LDR     R12, =0x673CC\n"
"                MOV     R1, #0x10000\n"
"                MOV     R0, R2,LSL#2\n"
"                ADD     R4, R3, R2,LSL#6\n"
"                MOV     R3, #0\n"
"loc_FF9376F8:\n"
"                STR     R1, [R5]\n"
"                STR     R0, [R12]\n"
"                STR     R3, [SP,#0x28-0x28]\n"
"loc_FF937704:\n"
"                LDR     R3, [SP,#0x28+0x24]\n"
"                LDR     R0, [R5]\n"
"                LDR     R2, =0x6742C\n"
"                LDR     R12, =0x6743A\n"
"                LDR     R1, [R2]\n"
"                STR     R0, [R3]\n"
"                LDR     R2, =0x67430\n"
"                LDRH    R3, [R12]\n"
"                LDR     R0, [R2]\n"
"                MOV     R3, R3,LSR#3\n"
"                MUL     LR, R3, R0\n"
"                LDR     R2, =0x6743C\n"
"                LDRH    R3, [R2]\n"
"                MUL     R11, R3, LR\n"
"                RSB     R12, R4, R6\n"
"                SUB     R12, R12, R11,LSL#1\n"
"                SUB     R12, R12, #0x3E800\n"
"                ADD     LR, R7, #3\n"
"                SUB     R12, R12, #0x10\n"
"                BIC     LR, LR, #3\n"
"                BIC     R12, R12, #0x7F00\n"
"                ADD     R4, LR, R4\n"
"                BIC     R12, R12, #0xFF\n"
"                ADD     R9, R4, R12\n"
"                LDR     R5, =0x67450\n"
"                ADD     R3, R9, #0x3E800\n"
"                LDR     R0, [SP,#0x28-0x28]\n"
"                STR     R3, [R5]\n"
"                LDR     R3, =0x673A8\n"
"                LDR     R2, =0x67428\n"
"                STR     R4, [R3,#4]\n"
"                LDR     R3, =0x67454\n"
"                LDR     R2, [R2]\n"
"                STR     R12, [R3]\n"
"                LDR     R3, =0x67444\n"
"                STR     LR, [R3]\n"
"                LDR     R3, =0x67448\n"
"                STR     R4, [R3]\n"
"                LDR     R3, =0x6744C\n"
"                STR     R9, [R3]\n"
"                LDR     R3, =0x673E8\n"
"                STR     R11, [R3]\n"
"                LDR     R3, =0x673A8\n"
"                SUBS    R1, R1, #0\n"
"                MOVNE   R1, #1\n"
"                STR     R4, [R3]\n"
"                BL      sub_FF91A3CC\n"
"                LDR     R2, =0x673E8\n"
"                LDR     R3, [R2]\n"
"                LDR     R2, =0x673E0\n"
"                ADD     R0, R0, R3\n"
"                STR     R0, [R2]\n"
"                ADD     SP, SP, #4\n"
"                LDMFD   SP!, {R4-R11,PC}\n"
 );
}