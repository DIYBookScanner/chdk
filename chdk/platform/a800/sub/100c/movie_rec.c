#include "conf.h"

int *video_quality = &conf.video_quality;
int *video_mode    = &conf.video_mode;

//ffedb168 A800
long def_table[24]={0x2000, 0x38D, 0x788, 0x5800, 0x9C5, 0x14B8, 0x10000, 0x1C6A, 0x3C45, 0x8000, 0xE35, 0x1E23,
           0x1CCD, -0x2E1, -0x579, 0x4F33, -0x7EB, -0xF0C, 0xE666, -0x170A, -0x2BC6, 0x7333, -0xB85, -0x15E3};

long table[24];

void change_video_tables(int a, int b){
 int i;
 for (i=0;i<24;i++) table[i]=(def_table[i]*a)/b; 
}

long CompressionRateTable[]={0x60, 0x5D, 0x5A, 0x57, 0x54, 0x51, 0x4D, 0x48, 0x42, 0x3B, 0x32, 0x29, 0x22, 0x1D, 0x17, 0x14, 0x10, 0xE, 0xB, 9, 7, 6, 5, 4, 3, 2, 1};

//FFD18384 (A495 = ffd0ca2c)
void __attribute__((naked,noinline)) movie_record_task(){ 
	asm volatile(
			"push	{r2, r3, r4, r5, r6, r7, r8, lr}\n"
			"ldr	r4,=0x5680\n" // [pc, #-2708]	; ffd178fc: (00005680) \n"
			"ldr	r7, =0x37f\n" //[pc, #928]	; ffd18734: (0000037f) \n"
			"ldr	r8, =0x2710\n" //[pc, #-2640]	; ffd17948: (00002710) \n"
			"mov	r5, #1\n"
			"mov	r6, #0\n"
"loc_ffd1839c:\n"
			"ldr	r0, [r4, #24]\n"
			"mov	r2, #0\n"
			"add	r1, sp, #4\n"
			"BL		sub_FFC2905C\n"
			"ldr	r0, [r4, #32]\n"
			"cmp	r0, #0\n"
			"BNE	loc_ffd1846c\n"
			"ldr	r0, [sp, #4]\n"
			"ldr	r1, [r0]\n"
			"sub	r1, r1, #2\n"
			"cmp	r1, #10\n"
			"addcc	pc, pc, r1, lsl #2\n"
			"B	loc_ffd1846c\n"
			"B	loc_ffd18420\n"
			"B	loc_ffd18440\n"
			"B	loc_ffd18450\n"
			"B	loc_ffd18458\n"
			"B	loc_ffd18428\n"
			"B	loc_ffd18460\n"
			"B	loc_ffd18430\n"
			"B	loc_ffd1846c\n"
			"B	loc_ffd18468\n"
			"B	loc_ffd183f8\n"
"loc_ffd183f8:\n"
			"ldr	r0, =0xffd18098\n" //[pc, #784]	; ffd18710: (ffd18098) \n"
			"str	r6, [r4, #52]\n" //	; 0x34\n"
			"str	r0, [r4, #168]\n" //	; 0xa8\n"
			"ldr	r2, =0xffd17a2c\n" //[pc, #-1436]	; ffd17e70: (ffd17a2c) \n"
			"ldr	r1, =0x82b78\n" //[pc, #-1436]	; ffd17e74: (00082b78) \n"
			"ldr	r0, =0xffd17b10\n" //[pc, #-1436]	; ffd17e78: (ffd17b10) \n"
			"str	r6, [r4, #36]\n" //	; 0x24\n"
			"BL		sub_FFCBF254\n"
			"str	r5, [r4, #56]\n" //	; 0x38\n"
			"B		loc_ffd1846c\n"
"loc_ffd18420:\n"
			"BL      unlock_optical_zoom\n"		//  +
			"BL		sub_FFD18190\n"
			"B		loc_ffd1846c\n"
"loc_ffd18428:\n"
			"BL		sub_FFD17E98_my\n"		//---------->
			"B		loc_ffd1846c\n"
"loc_ffd18430:\n"
			"ldr	r1, [r0, #16]\n"
			"ldr	r0, [r0, #4]\n"
			"BL		sub_FFE11D84\n"
			"B		loc_ffd1846c\n"
"loc_ffd18440:\n"
			"ldr	r0, [r4, #56]\n" //	; 0x38\n"
			"cmp	r0, #5\n"
			"strne	r5, [r4, #40]\n" //	; 0x28\n"
			"B		loc_ffd1846c\n"
"loc_ffd18450:\n"
			"BL		sub_FFD17C98\n"
			"B		loc_ffd1846c\n"
"loc_ffd18458:\n"
			"BL		sub_FFD17B5C\n"
			"B		loc_ffd1846c\n"
"loc_ffd18460:\n"
			"BL		sub_FFD179B8\n"
			"B		loc_ffd1846c\n"
"loc_ffd18468:\n"
			"BL		sub_FFD1866C\n"
"loc_ffd1846c:\n" // ; 11 refs\n"
			"ldr	r1, [sp, #4]\n"
			"ldr	r3, =0xffd1790c\n" //[pc, #-1520]	; ffd17e88: (ffd1790c)  **"MovieRecorder.c"\n"
			"str	r6, [r1]\n"
			"str	r7, [sp]\n"
			"ldr	r0, [r4, #28]\n"
			"mov	r2, r8\n"
			"BL		sub_FFC0F6A8\n"
			"B		loc_ffd1839c\n"
	);
}			

void __attribute__((naked,noinline)) sub_FFD17E98_my(){ 
	asm volatile(
			"push	{r4, r5, r6, r7, r8, lr}\n"
			"sub	sp, sp, #64\n" //	; 0x40\n"
			"mov	r6, #0\n"
			"ldr	r5, =0x5680\n" //[pc, #-1456]\n"	//; ffd178fc: (00005680) \n"
			"mov	r4, r0\n"
			"str	r6, [sp, #48]\n" //	; 0x30\n"
			"str	r6, [sp, #40]\n" //	; 0x28\n"
			"ldr	r0, [r5, #56]\n" //	; 0x38\n"
			"mov	r8, #4\n"
			"cmp	r0, #3\n"
			"streq	r8, [r5, #56]\n"	//; 0x38\n"
			"ldr	r0, [r5, #168]\n"	//; 0xa8\n"
			"BLX	r0\n"
			"ldr	r0, [r5, #56]\n"	//; 0x38\n"
			"cmp	r0, #4\n"
			"BNE	loc_ffd17f70\n"
			"add	r3, sp, #40\n" //	; 0x28\n"
			"add	r2, sp, #44\n" //	; 0x2c\n"
			"add	r1, sp, #48\n" //	; 0x30\n"
			"add	r0, sp, #52\n" //	; 0x34\n"
			"BL		sub_FFE11F18\n"
			"cmp	r0, #0\n"
			"mov	r7, #1\n"
			"BNE	loc_ffd17f14\n"
			"ldr	r1, [r5, #40]\n"	//; 0x28\n"
			"cmp	r1, #1\n"
			"BNE	loc_ffd17f78\n"
			"ldr	r1, [r5, #96]\n"	//; 0x60\n"
			"ldr	r2, [r5, #60]\n"	//; 0x3c\n"
			"cmp	r1, r2\n"
			"bcc	loc_ffd17f78\n"
"loc_ffd17f14:\n"
			"cmp	r0, #-2147483647\n" //	; 0x80000001\n"
			"streq	r8, [r5, #100]\n"	//; 0x64\n"
			"BEQ	loc_ffd17f4c\n"
			"cmp	r0, #-2147483645\n" //	; 0x80000003\n"
			"streq	r7, [r5, #100]\n"	//; 0x64\n"
			"BEQ	loc_ffd17f4c\n"
			"cmp	r0, #-2147483643\n" //	; 0x80000005\n"
			"moveq	r0, #2\n"
			"BEQ	loc_ffd17f48\n"
			"cmp	r0, #-2147483641\n" //	; 0x80000007\n"
			"strne	r6, [r5, #100]\n"	//; 0x64\n"
			"BNE	loc_ffd17f4c\n"
			"mov	r0, #3\n"
"loc_ffd17f48:\n"
			"str	r0, [r5, #100]\n"	//; 0x64\n"
"loc_ffd17f4c:\n" // ; 3 refs\n"
			"ldr	r0, =0x82ba4\n" //[pc, #-1588]\n"	//; ffd17920: (00082ba4) \n"
			"ldr	r0, [r0, #8]\n"
			"cmp	r0, #0\n"
			"BEQ	loc_ffd17f64\n"
			"BL		sub_FFC44E9C\n"
			"B		loc_ffd17f68\n"
"loc_ffd17f64:\n"
			"BL		sub_FFD179B8\n"
"loc_ffd17f68:\n"
			"mov	r0, #5\n"
			"str	r0, [r5, #56]\n"	//; 0x38\n"
"loc_ffd17f70:\n" // ; 3 refs\n"
			"add	sp, sp, #64\n" //	; 0x40\n"
			"pop	{r4, r5, r6, r7, r8, pc}\n"
"loc_ffd17f78:\n" // ; 2 refs\n"
			"ldr	ip, [sp, #48]\n"	//; 0x30\n"
			"cmp	ip, #0\n"
			"BEQ	loc_ffd18040\n"
			"str	r7, [r5, #44]\n"	//; 0x2c\n"
			"ldr	r0, [r5, #124]\n"	//; 0x7c\n"
			"ldr	r1, [r4, #20]\n"
			"ldr	r2, [r4, #24]\n"
			"ldr	r8, [r4, #12]\n"
			"add	r3, sp, #56\n" //	; 0x38\n"
			"add	lr, sp, #20\n"
			"stm	lr, {r0, r1, r2, r3}\n"
			"ldr	r3, [r5, #104]\n"	//; 0x68\n"
			"ldrd	r0, [sp, #40]\n"	//; 0x28\n"
			"add	r2, sp, #60\n" //	; 0x3c\n"
			"add	lr, sp, #8\n"
			"stm	lr, {r0, r2, r3}\n"
			"str	r1, [sp, #4]\n"
			"str	ip, [sp]\n"
			"ldmib	r4, {r0, r1}\n"
			"ldr	r3, [sp, #52]\n"	//; 0x34\n"
			"mov	r2, r8\n"
			"BL		sub_FFDE46FC\n"
			"ldr	r0, [r5, #16]\n"
			"ldr	r1, [r5, #88]\n"	//; 0x58\n"
			"BL		sub_FFC0F120\n"
			"cmp	r0, #9\n"
			"BNE	loc_ffd17ff4\n"
			"BL		sub_FFE124D0\n"
			"mov	r0, #589824\n" //	; 0x90000\n"
			"str	r7, [r5, #56]\n"	//; 0x38\n"
			"B		loc_ffd1800c\n"
"loc_ffd17ff4:\n"
			"ldr	r0, [sp, #56]\n"	//; 0x38\n"
			"cmp	r0, #0\n"
			"BEQ	loc_ffd18014\n"
			"BL		sub_FFE124D0\n"
			"mov	r0, #655360\n" //	; 0xa0000\n"
			"str	r7, [r5, #56]\n"	//; 0x38\n"
"loc_ffd1800c:\n"
			"BL		sub_FFC70540\n"
			"B		loc_ffd17f70\n"
"loc_ffd18014:\n"
			"BL		sub_FFDE47B4\n"
			"ldr	r0, [sp, #52]\n"	//; 0x34\n"
			"ldr	r1, [sp, #60]\n"	//; 0x3c\n"
			"BL		sub_FFE12290\n"
			"ldr	r0, [r5, #92]\n"	//; 0x5c\n"
			"ldr	r1, =0x56fc\n" //[pc, #1748]\n"	//; ffd18704: (000056fc) \n"
			"add	r0, r0, #1\n"
			"str	r0, [r5, #92]\n"	//; 0x5c\n"
			"ldr	r0, [sp, #60]\n"	//; 0x3c\n"
			"mov	r2, #0\n"
			"BL		sub_FFE10140_my\n"  //----------> patched
"loc_ffd18040:\n"
			"ldr	r0, [r5, #96]\n"	//; 0x60\n"
			"add	r0, r0, #1\n"
			"str	r0, [r5, #96]\n"	//; 0x60\n"
			"ldr	r1, [r5, #76]\n"	//; 0x4c\n"
			"mul	r0, r1, r0\n"
			"ldr	r1, [r5, #72]\n"	//; 0x48\n"
			"BL		sub_FFE99D88\n"
			"mov	r4, r0\n"
			"BL		sub_FFE12508\n"
			"ldr	r1, [r5, #128]\n"	//; 0x80\n"
			"cmp	r1, r4\n"
			"BNE	loc_ffd1807c\n"
			"ldr	r0, [r5, #48]\n"	//; 0x30\n"
			"cmp	r0, #1\n"
			"BNE	loc_ffd18090\n"
"loc_ffd1807c:\n"
			"ldr	r1, [r5, #140]\n"	//; 0x8c\n"
			"mov	r0, r4\n"
			"BLX	r1\n"
			"str	r4, [r5, #128]\n"	//; 0x80\n"
			"str	r6, [r5, #48]\n"	//; 0x30\n"
"loc_ffd18090:\n"
			"str	r6, [r5, #44]\n"	//; 0x2c\n"
			"B		loc_ffd17f70\n"
	);
}

void __attribute__((naked,noinline)) sub_FFE10140_my(){ 
	asm volatile(
			"push	{r4, r5, r6, r7, r8, r9, lr}\n"
			"ldr	r5, =0x9194\n" //[pc, #276]\n"	//; ffe10260: (00009194) \n"
			"ldr	r4, [r5]\n"
			"ldr	r2, [r5, #8]\n"
			"cmp	r4, #0\n"
			"ldrne	r3, [r5, #12]\n"
			"mov	r6, r2\n"
			"cmpne	r3, #1\n"
			"moveq	r2, #0\n"
			"streq	r0, [r5]\n"
			"streq	r2, [r5, #12]\n"
			"BEQ	loc_ffe1020c\n"
			"ldr	r3, [r5, #4]\n"
			"ldr	r7, =0xffedb168\n" //[pc, #236]\n"	//; ffe10268: (ffedb168) \n"
			"add	ip, r3, r3, lsl #1\n"
			"ldr	r3, [r7, ip, lsl #2]\n"
			"add	r8, r7, #48\n"	//; 0x30\n"
			"ldr	r9, [r8, ip, lsl #2]\n"
			"sub	r3, r4, r3\n"
			"cmp	r3, #0\n"
			"sub	r4, r4, r9\n"
			"BLE	loc_ffe101c8\n"
			"add	ip, r7, ip, lsl #2\n"
			"ldr	r4, [ip, #4]\n"
			"cmp	r4, r3\n"
			"addge	r2, r2, #1\n"
			"BGE	loc_ffe101bc\n"
			"ldr	ip, [ip, #8]\n"
			"cmp	ip, r3\n"
			"addlt	r2, r2, #3\n"
			"addge	r2, r2, #2\n"
"loc_ffe101bc:\n"
			//"cmp		r2, #23\n"   // -
			//"movge	r2, #22\n"   // -
			"CMP     R2, #0x1A\n"   // +
			"MOVGE   R2, #0x19\n"   // +
			"B	loc_ffe101fc\n"
"loc_ffe101c8:\n"
			"cmp	r4, #0\n"
			"BGE	loc_ffe101fc\n"
			"add	r3, r8, ip, lsl #2\n"
			"ldr	ip, [r3, #4]\n"
			"cmp	ip, r4\n"
			"suble	r2, r2, #1\n"
			"BLE	loc_ffe101f4\n"
			"ldr	r3, [r3, #8]\n"
			"cmp	r3, r4\n"
			"subgt	r2, r2, #3\n"
			"suble	r2, r2, #2\n"
"loc_ffe101f4:\n"
			"cmp	r2, #0\n"
			"movlt	r2, #0\n"
"loc_ffe101fc:\n" // ; 2 refs\n"
			"cmp	r2, r6\n"
			"strne	r2, [r5, #8]\n"
			"movne	r2, #1\n"
			"strne	r2, [r5, #12]\n"
"loc_ffe1020c:\n"
			"ldr	r2, =CompressionRateTable\n" //=0xffedb10c\n" // [pc, #80]\n"	//; ffe10264: (ffedb10c) \n"
			"ldr	r3, [r5, #8]\n"

			"LDR     R3, =video_mode\n"      // +
			"LDR     R3, [R3]\n"             // +
			"LDR     R3, [R3]\n"             // +
			"CMP     R3, #1\n"               // +
			"LDREQ   R3, =video_quality\n"   // +     
			"LDREQ   R3, [R3]\n"             // +     
			"LDREQ   R2, [R3]\n"             // +  

			"ldr	r2, [r2, r3, lsl #2]\n"
			"str	r2, [r1]\n"
			"str	r0, [r5]\n"
			"pop	{r4, r5, r6, r7, r8, r9, pc}\n"
	);
}	
